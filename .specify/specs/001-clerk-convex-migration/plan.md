# Plan: Clerk + Convex Integration

## Tech Stack

| Category | Technology | Version |
|----------|------------|---------|
| Framework | Expo SDK | 54.x |
| Language | TypeScript | 5.9.x |
| Auth | Clerk | @clerk/clerk-expo 2.x |
| Database | Convex | 1.x |
| State | Zustand | 5.x |
| Routing | Expo Router | 6.x |

## Architecture

```
┌────────────────────────────────────────────────────────────────┐
│                         App Layer                               │
├────────────────────────────────────────────────────────────────┤
│  Screens (app/)                                                │
│  ├── login.tsx          → Clerk SignIn                         │
│  ├── register.tsx       → Clerk SignUp                         │
│  ├── pairing.tsx        → Convex couples API                   │
│  └── (tabs)/            → Protected routes                     │
├────────────────────────────────────────────────────────────────┤
│  Providers                                                      │
│  ├── ClerkProvider      → Authentication context               │
│  ├── ConvexProvider     → Database context                     │
│  └── AuthProvider       → Unified auth interface (wraps Clerk) │
├────────────────────────────────────────────────────────────────┤
│  Services                                                       │
│  ├── lib/clerk.ts       → Clerk utilities                      │
│  └── lib/convex/        → Convex queries/mutations             │
└────────────────────────────────────────────────────────────────┘
         │                           │
         ▼                           ▼
   ┌──────────┐               ┌──────────┐
   │  Clerk   │               │  Convex  │
   │  Cloud   │               │  Cloud   │
   └──────────┘               └──────────┘
```

## Implementation Order

### Step 1: Clerk Setup (Auth Foundation)
**Goal:** Replace dummy auth with real Clerk authentication

**Tasks:**
1. Install `@clerk/clerk-expo`
2. Create Clerk account and get API keys
3. Configure `ClerkProvider` in `_layout.tsx`
4. Update `AuthProvider` to use Clerk hooks
5. Implement login screen with `SignIn`
6. Implement register screen with `SignUp`
7. Add Google OAuth provider
8. Add Apple OAuth provider (iOS)
9. Implement protected route middleware
10. Test sign-out functionality

**Files to modify:**
- `app/_layout.tsx`
- `providers/AuthProvider.tsx`
- `app/login.tsx`
- `app/register.tsx`
- `.env`

### Step 2: Convex Setup (Database Foundation)
**Goal:** Set up Convex backend and schema

**Tasks:**
1. Install `convex` package
2. Initialize Convex project (`npx convex dev`)
3. Define schema in `convex/schema.ts`
4. Create `convex/users.ts` - User CRUD
5. Create `convex/couples.ts` - Couple management
6. Create `convex/proposals.ts` - Proposal queries
7. Create `convex/swipes.ts` - Swipe recording
8. Create `convex/matches.ts` - Match detection
9. Create `convex/dailyUsage.ts` - Usage tracking
10. Configure `ConvexProvider` in `_layout.tsx`

**Files to create:**
- `convex/schema.ts`
- `convex/users.ts`
- `convex/couples.ts`
- `convex/proposals.ts`
- `convex/swipes.ts`
- `convex/matches.ts`
- `convex/dailyUsage.ts`

### Step 3: User Sync (Clerk ↔ Convex Bridge)
**Goal:** Automatically create Convex user when Clerk user signs up

**Tasks:**
1. Create `useUserSync` hook
2. Sync Clerk user to Convex on first sign-in
3. Update `AuthProvider` to include Convex user data
4. Handle user profile updates
5. Test full auth flow

**Files to modify:**
- `providers/AuthProvider.tsx`
- `hooks/useUserSync.ts` (new)

### Step 4: Feature Migration
**Goal:** Migrate all features from mock to Convex

**Tasks:**
1. Migrate pairing logic (`app/pairing.tsx`)
2. Migrate swipe recording (`app/(tabs)/index.tsx`)
3. Migrate matches display (`app/(tabs)/matches.tsx`)
4. Migrate schedule data (`app/(tabs)/schedule.tsx`)
5. Implement real-time subscriptions
6. Add daily usage limits with Convex
7. Test end-to-end flows

### Step 5: RevenueCat Preparation
**Goal:** Prepare infrastructure for future subscriptions

**Tasks:**
1. Add subscription fields to user schema
2. Create entitlement check function
3. Create paywall component (hidden by default)
4. Document RevenueCat integration
5. Add environment variables

**Files to create:**
- `lib/revenuecat.ts`
- `components/Paywall.tsx`

## File Structure After Implementation

```
love-ticket/
├── app/
│   ├── _layout.tsx          ← Add ClerkProvider + ConvexProvider
│   ├── login.tsx            ← Clerk SignIn
│   ├── register.tsx         ← Clerk SignUp
│   ├── pairing.tsx          ← Convex couples API
│   └── (tabs)/
│       ├── index.tsx        ← Convex swipes
│       ├── matches.tsx      ← Convex matches query
│       └── schedule.tsx     ← Convex schedule query
├── convex/
│   ├── _generated/          ← Auto-generated by Convex
│   ├── schema.ts            ← Database schema
│   ├── users.ts             ← User mutations/queries
│   ├── couples.ts           ← Couple mutations/queries
│   ├── proposals.ts         ← Proposal queries
│   ├── swipes.ts            ← Swipe mutations
│   ├── matches.ts           ← Match mutations/queries
│   └── dailyUsage.ts        ← Usage tracking
├── providers/
│   └── AuthProvider.tsx     ← Wraps Clerk + Convex user
├── hooks/
│   └── useUserSync.ts       ← Sync Clerk → Convex
├── lib/
│   └── revenuecat.ts        ← Future RevenueCat setup
├── components/
│   └── Paywall.tsx          ← Future paywall
└── .env                     ← API keys
```

## API Contracts

### Clerk Auth Flow
```typescript
// After Clerk sign-in, get token
const { getToken, userId, isSignedIn } = useAuth();

// Token includes Convex-compatible claims
const token = await getToken({ template: "convex" });
```

### Convex API Examples
```typescript
// Get current user
const user = useQuery(api.users.getByClerkId, { clerkId: userId });

// Create couple
const coupleId = await mutation(api.couples.create, {
  inviteCode: generateCode()
});

// Join couple
await mutation(api.couples.join, {
  inviteCode: "ABC123"
});

// Record swipe
await mutation(api.swipes.create, {
  proposalId,
  direction: "right"
});

// Watch for matches (real-time)
const matches = useQuery(api.matches.getForCouple);
```

## Testing Strategy

### Manual Testing Checklist
- [ ] Sign up with email/password
- [ ] Sign in with email/password
- [ ] Sign in with Google
- [ ] Sign in with Apple (iOS device)
- [ ] Sign out
- [ ] Create couple (generate code)
- [ ] Join couple (enter code)
- [ ] Swipe left (nope)
- [ ] Swipe right (like) - verify limit
- [ ] Swipe up (super like) - verify limit
- [ ] Verify match appears for both users
- [ ] Kill app and verify session persists

### Test Accounts
Create test accounts in Clerk dashboard:
- `test1@example.com` / `Test1234!`
- `test2@example.com` / `Test1234!`

## Rollback Plan
If issues arise:
1. Revert to dummy AuthProvider
2. Keep mock data in stores
3. App remains functional without backend

## Dependencies

```json
{
  "dependencies": {
    "@clerk/clerk-expo": "^2.0.0",
    "convex": "^1.0.0",
    "expo-secure-store": "~15.0.8"
  }
}
```

## Estimated Timeline
- Step 1 (Clerk): 2-3 hours
- Step 2 (Convex): 2-3 hours
- Step 3 (Sync): 1 hour
- Step 4 (Migration): 3-4 hours
- Step 5 (RevenueCat prep): 1 hour

**Total: ~10-12 hours**
